{% extends 'layout/base.html' %}

{% block title %}Liste des répertoires{% endblock %}

{% block content %}
{% load tz %}

<style>
    /* Palette de couleurs améliorée */
    #retoursTable {
        width: 100%;
        border-collapse: collapse;
        box-shadow: 0 2px 3px rgba(0,0,0,0.1);
    }

    #retoursTable thead {
        position: sticky;
        top: 0;
        background-color: #2c3e50; /* Bleu nuit élégant */
        color: #FFFFFF;
        z-index: 10;
    }

    #retoursTable th, #retoursTable td {
        border: 1px solid #e0e0e0;
        padding: 10px;
        text-align: left;
        transition: background-color 0.3s ease;
    }

    /* Styles de lignes spécifiques */
    #retoursTable tbody tr.success {
        background-color: #e6f3e6; /* Vert très clair, doux pour les yeux */
        color: #006400; /* Vert foncé pour le texte */
    }

    #retoursTable tbody tr.warning {
        background-color: #fff3cd; /* Jaune très clair */
        color: #856404; /* Marron foncé pour le texte */
    }

    #retoursTable tbody tr.danger {
        background-color: #f8d7da; /* Rose très clair */
        color: #721c24; /* Rouge foncé pour le texte */
    }

    /* Ligne paire pour les lignes non-colorées */
    #retoursTable tbody tr:nth-child(even):not(.success):not(.warning):not(.danger) {
        background-color: #f8f9fa; /* Gris très clair */
    }

    /* Hover effect */
    #retoursTable tbody tr:hover:not(.success):not(.warning):not(.danger) {
        background-color: #f1f3f5;
    }

    /* Autres styles */
    .designation-col {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Boutons dans le tableau */
    .btn-action {
        margin: 0 2px;
        padding: 4px 8px;
    }
</style>

<div class="container mt-4">
    {% if messages %}
    <div class="alert-container">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <h1 class="text-center mb-4">GESTION DES RETOURS</h1>

    <div class="row mb-3">
        <div class="col-md-6">
            <a href="{% url 'retour_list' %}" class="btn btn-secondary">
                <i class="fas fa-chevron-left"></i> RETOUR
            </a>
        </div>
    </div>

    <!-- Formulaire de recherche -->
    <div class="card mb-3">
        <div class="card-body">
            <form id="searchForm" action="{% url 'consultation_list_retour' %}" method="GET">
                <div class="form-row align-items-center">
                    <div class="col-md-8">
                        <input type="text" 
                               class="form-control" 
                               id="searchInput" 
                               name="search" 
                               placeholder="Rechercher par nom" 
                               value="{{ search_query }}"
                               oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-search"></i> RECHERCHE
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tableau des répertoires -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover" id="retoursTable">
            <thead>
                <tr>
                    <th>DATE</th>
                    <th>NOM</th>
                    <th>PRENOM</th>
                    <th>FOURNISSEUR</th>
                    <th>MARQUE</th>
                    <th>DESIGNATION</th>
                    <th>CODE BARRE</th>
                    <th>AVOIR</th>
                    <th>ACTIONS</th>
                </tr>
            </thead>
            <tbody>
                {% for retour in retours %}
                <tr class="success">
                    <td>{{ retour.date | date:"d-m-Y" }}</td>
                    <td>{{ retour.nom|upper }}</td>
                    <td>{{ retour.prenom|upper }}</td>
                    <td>{{ retour.fournisseur|upper }}</td>
                    <td>{{ retour.marque|upper|default:"-" }}</td>
                    <td class="designation-col">{{ retour.designation|default:"-" }}</td>
                    <td>{{ retour.code|default:"-" }}</td>
                    <td>
                        {% if retour.facture %}
                            <a href="{{ retour.facture.url }}" target="_blank" class="btn btn-sm btn-info btn-action">
                                <i class="fas fa-file-pdf"></i> VOIR
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <a href="{% url 'edit_retour' id=retour.id %}?previous_url={{ request.path }}" 
                               class="btn btn-sm btn-warning btn-action" 
                               title="Éditer">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% if not retour.facture %}
                                <a href="{% url 'valider_retour' id=retour.id %}" 
                                   class="btn btn-sm btn-success btn-action" 
                                   title="Valider">
                                    <i class="fas fa-check-circle"></i>
                                </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">Aucun retour trouvé.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination (identique à l'exemple précédent) -->
    {% if is_paginated %}
    <nav aria-label="Navigation des retours">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                        <i class="fas fa-angle-left"></i>
                    </a>
                </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                            {{ num }}
                        </a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                        <i class="fas fa-angle-right"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}